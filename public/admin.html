<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Moderation</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b1020'/%3E%3Cpath d='M16 40l8-12 8 10 8-14 8 16' stroke='%237cc2ff' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b1020; color:#e5ecff; }
    header { padding:16px 20px; font-weight:700; font-size:24px; }
    .bar { display:flex; gap:8px; padding:0 20px 16px; align-items:center; }
    input[type="text"] { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #2a3355; background:#0f1530; color:#e5ecff; }
    button { padding:10px 14px; background:#1b53ff; color:#fff; border:none; border-radius:10px; font-weight:600; }
    .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:12px; padding:0 20px 40px; }
    .card { background:#0f1530; border:1px solid #2a3355; border-radius:14px; overflow:hidden; }
    .card header { font-size:16px; padding:12px 14px; border-bottom:1px solid #2a3355; }
    .media { padding:12px 14px; display:flex; flex-direction:column; gap:8px; }
    video, img { width:100%; border-radius:10px; background:#000; }
    .actions { display:flex; gap:8px; padding:12px 14px; }
    .muted { color:#90a0d0; font-size:12px; padding:0 20px 12px; }
    .error { color:#ff7a7a; padding:0 20px 10px; }
  </style>
</head>
<body>
  <header>Admin Moderation</header>
  <div class="bar">
    <input id="init" type="text" placeholder="Paste Telegram initData here (or it will auto-fill from Telegram)" />
    <button id="save">Save</button>
    <button id="reload">Reload</button>
  </div>
  <div class="muted">Tip: you can pass initData via URL like <code>?initData=...</code>. It will be used automatically.</div>
  <div id="status" class="muted"></div>
  <div id="error" class="error"></div>
  <section id="cards" class="cards"></section>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const input = document.getElementById('init');
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');
  const cards = document.getElementById('cards');

  function getInitData(){
    const tga = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp.initData : '';
    if (tga) return tga;
    const fromQS = qs.get('initData'); if (fromQS) return fromQS;
    const fromLS = localStorage.getItem('tg_init_data'); if (fromLS) return fromLS;
    return input.value.trim();
  }

  async function auth() {
    errorEl.textContent = '';
    const initData = getInitData();
    input.value = initData;
    if (!initData) { errorEl.textContent = 'No initData: open via Telegram or paste initData.'; return null; }
    const r = await fetch('/api/auth-me', { method: 'POST', headers: { 'x-tg-initdata': initData } });
    if (!r.ok) {
      const t = await r.text().catch(()=>'');
      throw new Error(t || r.statusText);
    }
    const me = await r.json();
    statusEl.textContent = `Authed as @${me.username || ''} (${me.tg_id}) role=${me.role}`;
    return initData;
  }

  async function loadPending(initData){
    const r = await fetch('/api/admin-verifications', { headers: { 'x-tg-initdata': initData }});
    if (!r.ok) { throw new Error(await r.text()); }
    const list = await r.json(); // expect array of rows
    cards.innerHTML = '';
    for (const v of list) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = \`
        <header>#\${v.id} â€” status: \${v.status}</header>
        <div class="media">
          <video controls src="/api/signed-download?path=\${encodeURIComponent(v.video_path)}"></video>
          <img alt="document" src="/api/signed-download?path=\${encodeURIComponent(v.doc_path)}" onerror="this.outerHTML='<a href=\'/api/signed-download?path=\${encodeURIComponent(v.doc_path)}\' target=\'_blank\'>Open document</a>'">
        </div>
        <div class="actions">
          <button data-id="\${v.id}" data-act="approve">Approve</button>
          <button data-id="\${v.id}" data-act="reject">Reject</button>
        </div>
      \`;
      cards.appendChild(card);
    }

    cards.addEventListener('click', async (e) => {
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      const r2 = await fetch('/api/admin-review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-tg-initdata': initData },
        body: JSON.stringify({ id, action: act, notes: act==='reject' ? 'Rejected by admin' : undefined })
      });
      if (!r2.ok) { alert(await r2.text()); return; }
      alert('OK'); location.reload();
    }, { once: true });
  }

  document.getElementById('save').onclick = () => {
    localStorage.setItem('tg_init_data', input.value.trim());
    statusEl.textContent = 'Saved initData to local storage.';
  };
  document.getElementById('reload').onclick = () => location.href = location.pathname + '?initData=' + encodeURIComponent(input.value.trim());

  (async () => {
    try {
      const init = await auth();
      if (!init) return;
      await loadPending(init);
    } catch (err) {
      errorEl.textContent = 'Error: ' + (err && err.message || String(err));
    }
  })();
})();
</script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
